# 항해 99 TIL - 2023.02.13

### 항해 99 TIL 일지

### 실전 프로젝트 완료!
- 프로젝트 도중에 TIL 쓰는게 쉽지 않아 결국 한달동안이나 밀려버렸다
- 마지막 TIL 이후 배웠던 내용들 대략적으로 정리
- Redis 캐싱 속도 개선
  - 도시데이터 API가 URL 하나로 서울 50개 지역을 하나하나 호출해야하다 보니 캐싱 시간이 3~4분 소요
  - 데이터 정확성이 의심되는 상황
  - 복수의 인증키 + 하나의 인증키로 여러 지역 동시 호출을 진행
  - 한개의 인증키로 과다한 요청을 보낼 시 중복 요청 에러가 발생하나 5개 지역의 호출까지는 보통 문제 없음을 확인
  - 5개 인증키 X 5개 지역, 총 25개 지역을 Promise.all로 동시 호출
  - API 동시 호출 시 응답 속도가 느려져 약 1분 소요
  - 캐싱 속도를 더 개선하기 위해 인구, 도로, 날씨, 대기환경, 버스 정보 등의 캐싱도 Promise.all로 진행
  - 캐싱 속도를 228초에서 55초, 총 76%를 단축할 수 있었다

- Redis 캐싱 전략
  - 도시데이터 API와 대기환경 API에서 가져온 데이터들의 문제점이 몇가지 있었다
    - 도시데이터 API는 간헐적으로 전체 또는 일부 응답값이 없거나, 미세먼지 수치가 점검중으로 뜨는 경우가 있음
    - 대기환경 API는 간헐적으로 오염물질 수치가 점검중으로 뜨는 경우가 있음
    - 캐시에 데이터 없을 시 필요한 정보를 조회할 DB 부재
    - 서비스 핵심인 실시간 데이터 제공에 필요한 정확도 높은 데이터 전달에 차질이 생김
  - 이를 해결하기위해 캐싱 전략을 찾아봤는데 여러가지 전략이 있었고, 프로젝트에 적합하다 생각한 전략을 선택했다
  - 대기환경 API: 해당 API의 업데이트 주기는 1시간, 해당 데이터 읽음 빈도는 높음, 데이터 유실이 간헐적으로 발생
    - 원래 해당 API의 업데이트 주기를 따라 스케쥴러로 1시간 마다 데이터를 Redis에 캐싱시켰었고 저장시키는 데이터도 서울시 25개 행정구 오염물질 4가지(오존, 이산화질소, 일산화탄소, 아황산가스) 수치이기 때문에 데이터 크기가 별로 크지 않아 정확도를 보장하는 Write Through 전략 채택
    - 응답 값이 정상적일 경우 Redis + MySQL 동시 저장
    - 해당 API에서 점검중을 반환할 경우 해당 행정구 데이터는 저장시키지 않음
    - 캐시에 데이터 없을 경우 DB 응답값을 호출과 동시에 캐싱시켜 다음번 호출은 빠르게 반환할 수 있게 설정 (Look Aside)
  - 도시데이터 API: 업데이트 주기 5분, 읽음 빈도 높음, 간헐적 데이터 유실 발생
    - 원래 해당 API의 업데이트 주기를 따라 스케쥴러로 5분마다 데이터를 Redis에 캐싱시켰었음
    - 하지만 서버 상태에 따라 해당 API 응답 자체가 없는 경우가 있어 5분마다 캐싱 시도를 하는것이고 실제 도시데이터 인구 자료의 갱신은 30분 이상 밀리는 경우도 확인
    - 또한 해당 API에서 제공하는 데이터 크기가 크다보니 5분마다 캐싱하고 15분마다 DB에 백업하는 Write Back 전략을 채택함
    - 조회 로직은 대기환경과 동일하게 읽음 빈도가 높으므로 Look Aside 전략 채택
    - 호출 로직은 대기환경 API와 동일

- Elasticache
  - 원래는 BE 서버를 구동시키고 있는 EC2 인스턴스에 설치해둔 로컬 Redis에 데이터를 캐싱시켜두고 있었음
  - 시험 삼아 BE 서버를 계속 켜뒀었는데 Redis에 저장된 데이터가 주기적으로 사라짐을 확인(아래 사진과 같이 외부 IP에서 flushall 공격이 들어왔다)

    ![중국IP 공격](https://user-images.githubusercontent.com/110752019/218380705-c96d163c-f9e7-4d59-91f2-6fec81ae0b37.png)
  - 외부 공격을 막을 수 있는 안전한 Redis 환경이 필요했다
  - Elasticache와 Redis server를 고민했었고 편의성과 보안이 더 나은 Elasticache를 선택